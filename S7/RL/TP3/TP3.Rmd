---
title: "TP Régression linéaire"
author: "Simon Desdevises"
date: "03/10/2025"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_data}
data <- read.csv(
  "/Users/simondesdevises/Documents/Polytech/IS2A/S7/RL/TP3/data.csv",
  header = TRUE
)
rownames(data) <- data$Y
```

## 1.1 Statistiques descriptives univariées

### Statistiques descriptives de toutes les variables

```{r stats_univariees}
# Statistiques descriptives complètes
knitr::kable(summary(data[, 1:7]))
```

## 1.2 Statistiques descriptives bivariées

### Matrice de corrélation

```{r correlation}
# Matrice de corrélation
cor_matrix <- cor(data)
print("Matrice de corrélation :")
print(round(cor_matrix, 3))

# Corrélations de Y avec les autres variables
print("Corrélations de Y avec les variables explicatives :")
cor_y <- cor(data)[, "Y"]
print(sort(cor_y, decreasing = TRUE))
```

### Analyse détaillée des relations bivariées

```{r analyse_bivariee}
cat("\n=== ANALYSE BIVARIÉE DÉTAILLÉE ===\n\n")
for (i in seq_len(ncol(data[, 1:7]))) {
  var_name <- colnames(data)[i]
  cat("\n--- Variable:", var_name, "---\n")

  cor_val <- cor(data[, i], data$Y)
  cat("Corrélation avec Y:", round(cor_val, 4), "\n")

  model <- lm(Y ~ data[, i], data = data)
  cat("R² de la régression simple:", round(summary(model)$r.squared, 4), "\n")
  cat("p-value:", format.pval(summary(model)$coefficients[2, 4]), "\n")
}
```

## 2. Régression linéaire multiple

### Modèle complet avec toutes les variables

```{r regression_multiple}
# Régression linéaire multiple : Y en fonction de toutes les variables X1 à X7
model_complet <- lm(Y ~ X1 + X2 + X3 + X4 + X5 + X6 + X7, data = data)

# Affichage du résumé du modèle
cat("\n=== MODÈLE DE RÉGRESSION LINÉAIRE MULTIPLE ===\n\n")
print(summary(model_complet))

# Coefficients du modèle
cat("\n=== COEFFICIENTS DU MODÈLE ===\n")
print(round(coef(model_complet), 4))

# Qualité de l'ajustement
cat("\n=== QUALITÉ DE L'AJUSTEMENT ===\n")
cat("R² :", round(summary(model_complet)$r.squared, 4), "\n")
cat("R² ajusté :", round(summary(model_complet)$adj.r.squared, 4), "\n")
cat("Erreur résiduelle :", round(summary(model_complet)$sigma, 4), "\n")
cat("Nombre d'observations :", nobs(model_complet), "\n")
cat("Degrés de liberté :", summary(model_complet)$df[2], "\n")
```

On observe que X7 ne peut pas être estimé. Cela est logique car il est corrélé avec les autres variables `X7 = 1 - (X1 + X2 + X3 + X4 + X5 + X6)`.

### Constatations

```{r constatations}
cat("\n=== ANALYSE DES RÉSULTATS ===\n\n")

# 1. Analyse de la significativité globale du modèle
f_stat <- summary(model_complet)$fstatistic
p_value_global <- pf(f_stat[1], f_stat[2], f_stat[3], lower.tail = FALSE)
cat("1. SIGNIFICATIVITÉ GLOBALE DU MODÈLE\n")
cat("   F-statistic:", round(f_stat[1], 4), "\n")
cat("   p-value:", format.pval(p_value_global), "\n")
if (p_value_global < 0.05) {
  cat("Le modèle est globalement significatif (p < 0.05)\n")
} else {
  cat("Le modèle n'est pas significatif (p >= 0.05)\n")
}

# 2. Analyse des coefficients individuels
cat("\n2. SIGNIFICATIVITÉ DES VARIABLES INDIVIDUELLES\n")
coef_summary <- summary(model_complet)$coefficients
for (i in 2:nrow(coef_summary)) {
  var_name <- rownames(coef_summary)[i]
  p_val <- coef_summary[i, 4]
  cat("   ", var_name, ":")
  if (p_val < 0.05) {
    cat(" SIGNIFICATIF (p =", format.pval(p_val), ")\n")
  } else {
    cat(" NON significatif (p =", format.pval(p_val), ")\n")
  }
}
```

Le modèle en lui même est significatif cependant les Variables individuelles ne sont pas significatives. Cela est logique car les variables sont corrélées entre elles.

## 3. Vérification de la multi-colinéarité

### Vérification de la somme des composantes

```{r verification_multicolinearite}
# Les variables X's représentent les taux de chaque composante dans l'essence
# La somme sur chaque ligne doit faire 100% (ou 1)
cat("=== VÉRIFICATION DE LA SOMME DES COMPOSANTES ===\n\n")

# Calculer la somme de X1 à X7 pour chaque ligne
sommes <- apply(data[, 1:7], 1, sum)
cat("Somme X1 + X2 + ... + X7 pour chaque observation :\n")
print(round(sommes, 4))

cat("\nToutes les sommes sont égales à 1 :", all(round(sommes, 10) == 1), "\n")
```

### Calcul du déterminant de X^T X

```{r determinant_XTX}
cat("\n=== DÉTERMINANT DE LA MATRICE X^T X ===\n\n")

X <- as.matrix(data[, 1:7])
XTX <- t(X) %*% X

cat("Déterminant de X^T X :", det(XTX), "\n")

if (abs(det(XTX)) < 1e-10) {
  cat("\n→ Le déterminant est nul \n")
  cat("Cela confirme la multi-colinéarité\n")
}

cat("\n=== CONCLUSION ===\n")
cat("On n'a pas besoin des 7 variables puisque 6 suffisent !\n")
cat("La 7ème variable est automatiquement déterminée par les 6 autres.\n")
```
  
## 4 Choix des variables

```{r choix_variables}
library(leaps)
choix <- regsubsets(
  Y ~ .,
  int = TRUE,
  nbest = 1,
  nvmax = 7,
  method = "exh",
  data = data
)
res <- summary(choix)
print(res)
#choix du meilleur modèle selon le critère BIC
plot(choix, scale = "bic")
```

### 4-A Identification du meilleur modèle

```{r identification_meilleur_modele}
# Identifier le modèle avec le BIC minimum
cat("=== IDENTIFICATION DU MEILLEUR MODÈLE ===\n\n")

# Trouver le nombre de variables optimal selon BIC
bic_values <- res$bic
meilleur_idx <- which.min(bic_values)
cat("Nombre de variables du meilleur modèle :", meilleur_idx, "\n")
cat("Valeur du BIC minimum :", round(bic_values[meilleur_idx], 4), "\n\n")

# Afficher les variables sélectionnées
cat("Variables incluses dans le meilleur modèle :\n")
variables_selectionnees <- names(which(res$which[meilleur_idx, ]))
variables_selectionnees <- variables_selectionnees[variables_selectionnees != "(Intercept)"]
print(variables_selectionnees)
```

**Réponse :** Le meilleur modèle selon le critère BIC contient **`r meilleur_idx` variables** : `r paste(variables_selectionnees, collapse = ", ")`.

#### Estimation du meilleur modèle

```{r estimation_meilleur_modele}
m2 <- lm(Y ~ X1 + X4 + X6, data = data)
summary(m2)
```

```{r constatations_m2}
cat("\n=== ANALYSE DES RÉSULTATS DU MODÈLE 2 ===\n\n")

f_stat <- summary(m2)$fstatistic
p_value_global <- pf(f_stat[1], f_stat[2], f_stat[3], lower.tail = FALSE)
cat("1. SIGNIFICATIVITÉ GLOBALE DU MODÈLE\n")
cat("   F-statistic:", round(f_stat[1], 4), "\n")
cat("   p-value:", format.pval(p_value_global), "\n")
if (p_value_global < 0.05) {
  cat("Le modèle est globalement significatif (p < 0.05)\n")
} else {
  cat("Le modèle n'est pas significatif (p >= 0.05)\n")
}

cat("\n2. SIGNIFICATIVITÉ DES VARIABLES INDIVIDUELLES\n")
coef_summary <- summary(m2)$coefficients
for (i in 2:nrow(coef_summary)) {
  var_name <- rownames(coef_summary)[i]
  p_val <- coef_summary[i, 4]
  cat("   ", var_name, ":")
  if (p_val < 0.05) {
    cat(" SIGNIFICATIF (p =", format.pval(p_val), ")\n")
  } else {
    cat(" NON significatif (p =", format.pval(p_val), ")\n")
  }
}
```

Contrariément au modèle complet, les variables individuelles sont cette fois significatives.

### 4-B Modèle avec 2 variables

```{r choix_var_2}
variables_selectionnees <- names(which(res$which[2, ]))
variables_selectionnees <- variables_selectionnees[variables_selectionnees != "(Intercept)"]
print(variables_selectionnees)
```

## 5 Changement de critère

### Critère Cp de Mallows

```{r meilleur_modele_cp}
cat("\n=== MEILLEUR MODÈLE SELON LE CRITÈRE Cp ===\n\n")

# Identifier le modèle avec le Cp minimum
cp_values <- res$cp
meilleur_idx_cp <- which.min(cp_values)
cat("Nombre de variables du meilleur modèle :", meilleur_idx_cp, "\n")
cat("Valeur du Cp minimum :", round(cp_values[meilleur_idx_cp], 4), "\n\n")

# Afficher les variables sélectionnées
cat("Variables incluses dans le meilleur modèle :\n")
variables_cp <- names(which(res$which[meilleur_idx_cp, ]))
variables_cp <- variables_cp[variables_cp != "(Intercept)"]
print(variables_cp)

# Plot spécifique pour Cp
plot(choix, scale = "Cp", main = "Sélection de variables selon Cp")
```

**Réponse Cp :** Le meilleur modèle selon le critère Cp de Mallows contient **`r meilleur_idx_cp` variables** : `r paste(variables_cp, collapse = ", ")`.

### Critère R² ajusté

```{r meilleur_modele_adjr2}
cat("\n=== MEILLEUR MODÈLE SELON LE CRITÈRE R² AJUSTÉ ===\n\n")

# Identifier le modèle avec le R² ajusté maximum
adjr2_values <- res$adjr2
meilleur_idx_adjr2 <- which.max(adjr2_values)
cat("Nombre de variables du meilleur modèle :", meilleur_idx_adjr2, "\n")
cat("Valeur du R² ajusté maximum :", round(adjr2_values[meilleur_idx_adjr2], 4), "\n\n")

# Afficher les variables sélectionnées
cat("Variables incluses dans le meilleur modèle :\n")
variables_adjr2 <- names(which(res$which[meilleur_idx_adjr2, ]))
variables_adjr2 <- variables_adjr2[variables_adjr2 != "(Intercept)"]
print(variables_adjr2)

# Plot spécifique pour R² ajusté
plot(choix, scale = "adjr2", main = "Sélection de variables selon R² ajusté")
```

**Réponse R² ajusté :** Le meilleur modèle selon le critère R² ajusté contient **`r meilleur_idx_adjr2` variables** : `r paste(variables_adjr2, collapse = ", ")`.

### Critère R²

```{r meilleur_modele_r2}
cat("\n=== MEILLEUR MODÈLE SELON LE CRITÈRE R² ===\n\n")

# Identifier le modèle avec le R² maximum
r2_values <- res$rsq
meilleur_idx_r2 <- which.max(r2_values)
cat("Nombre de variables du meilleur modèle :", meilleur_idx_r2, "\n")
cat("Valeur du R² maximum :", round(r2_values[meilleur_idx_r2], 4), "\n\n")

# Afficher les variables sélectionnées
cat("Variables incluses dans le meilleur modèle :\n")
variables_r2 <- names(which(res$which[meilleur_idx_r2, ]))
variables_r2 <- variables_r2[variables_r2 != "(Intercept)"]
print(variables_r2)

# Plot spécifique pour R²
plot(choix, scale = "r2", main = "Sélection de variables selon R²")
```

**Réponse R² :** Le meilleur modèle selon le critère R² contient **`r meilleur_idx_r2` variables** : `r paste(variables_r2, collapse = ", ")`.

### Synthèse comparative

```{r synthese_criteres}
cat("\n=== SYNTHÈSE DES CRITÈRES DE SÉLECTION ===\n\n")

synthese <- data.frame(
  Critere = c("BIC", "Cp de Mallows", "R² ajusté", "R²"),
  Nombre_Variables = c(
    meilleur_idx,
    meilleur_idx_cp,
    meilleur_idx_adjr2,
    meilleur_idx_r2
  ),
  Variables = c(
    paste(variables_selectionnees, collapse = ", "),
    paste(variables_cp, collapse = ", "),
    paste(variables_adjr2, collapse = ", "),
    paste(variables_r2, collapse = ", ")
  ),
  Valeur = c(
    round(res$bic[meilleur_idx], 4),
    round(res$cp[meilleur_idx_cp], 4),
    round(res$adjr2[meilleur_idx_adjr2], 4),
    round(res$rsq[meilleur_idx_r2], 4)
  )
)

knitr::kable(
  synthese,
  col.names = c("Critère", "Nb Variables", "Variables sélectionnées", "Valeur")
)
```

## 6 Sélection de variables pas-à-pas

Les recherches précédentes étaient exhaustives. Cela pose un problème lorsque le nombre de variables est grand. Faisons une sélection de variables pas-à-pas.

### Définition de la fonction PRESS

```{r fonction_press}
press <- function(fit) {
  h <- lm.influence(fit)$hat
  sqrt(mean((residuals(fit) / (1 - h))^2))
}
```

### Sélection backward (pas-à-pas descendante)

```{r selection_backward}
library(MASS)

# Modèle sans aucune variable explicative
m_0 <- lm(Y ~ 1, data = data)

# Modèle avec toutes les variables
m_all <- lm(Y ~ ., data = data)

# Sélection backward (on part du modèle complet et on retire des variables)
cat("=== SÉLECTION BACKWARD ===\n\n")
m_back <- stepAIC(m_all, direction = "backward", trace = TRUE)

cat("\n--- Résumé du modèle backward ---\n")
print(summary(m_back))
```

### Sélection forward (pas-à-pas ascendante)

```{r selection_forward}
# Sélection forward (on part du modèle vide et on ajoute des variables)
cat("\n=== SÉLECTION FORWARD ===\n\n")
m_forw <- stepAIC(
  m_0,
  direction = "forward",
  scope = list(upper = m_all, lower = m_0),
  trace = TRUE
)

cat("\n--- Résumé du modèle forward ---\n")
print(summary(m_forw))
```

### Sélection stepwise (bidirectionnelle)

```{r selection_stepwise}
# Sélection stepwise (on peut ajouter ou retirer des variables)
cat("\n=== SÉLECTION STEPWISE (BIDIRECTIONNELLE) ===\n\n")
m_stepwise <- stepAIC(
  m_0,
  direction = "both",
  scope = list(upper = m_all, lower = m_0),
  trace = TRUE
)

cat("\n--- Résumé du modèle stepwise ---\n")
print(summary(m_stepwise))
```

### Comparaison des modèles selon le critère PRESS

```{r comparaison_press}
cat("\n=== COMPARAISON DES MODÈLES SELON LE CRITÈRE PRESS ===\n\n")

# Calcul du PRESS pour chaque modèle
press_back <- press(m_back)
press_forw <- press(m_forw)
press_stepwise <- press(m_stepwise)

# Extraction des variables de chaque modèle
vars_back <- names(coef(m_back))[-1]  # Exclure l'intercept
vars_forw <- names(coef(m_forw))[-1]
vars_stepwise <- names(coef(m_stepwise))[-1]

# Tableau comparatif
comparaison_modeles <- data.frame(
  Methode = c("Backward", "Forward", "Stepwise"),
  Nb_Variables = c(
    length(vars_back),
    length(vars_forw),
    length(vars_stepwise)
  ),
  Variables = c(
    paste(vars_back, collapse = ", "),
    paste(vars_forw, collapse = ", "),
    paste(vars_stepwise, collapse = ", ")
  ),
  AIC = c(
    AIC(m_back),
    AIC(m_forw),
    AIC(m_stepwise)
  ),
  PRESS = c(
    press_back,
    press_forw,
    press_stepwise
  ),
  R2 = c(
    summary(m_back)$r.squared,
    summary(m_forw)$r.squared,
    summary(m_stepwise)$r.squared
  ),
  R2_ajuste = c(
    summary(m_back)$adj.r.squared,
    summary(m_forw)$adj.r.squared,
    summary(m_stepwise)$adj.r.squared
  )
)

knitr::kable(
  comparaison_modeles,
  col.names = c(
    "Méthode",
    "Nb Var",
    "Variables sélectionnées",
    "AIC",
    "PRESS",
    "R²",
    "R² ajusté"
  ),
  digits = 4
)

# Identifier le meilleur modèle selon PRESS
meilleur_press <- which.min(comparaison_modeles$PRESS)
cat("\n=== MEILLEUR MODÈLE SELON LE CRITÈRE PRESS ===\n")
cat("Méthode :", comparaison_modeles$Methode[meilleur_press], "\n")
cat("PRESS :", round(comparaison_modeles$PRESS[meilleur_press], 4), "\n")
cat("Variables :", comparaison_modeles$Variables[meilleur_press], "\n")
```
